"""pqc.io.libstempo_loader

Extract TOA-level arrays from libstempo tempopulsar into a DataFrame.

This must include the observing frequency used by the TOA (psr.freqs).
"""

from __future__ import annotations
from pathlib import Path
import numpy as np
import pandas as pd
import libstempo as lt

def load_libstempo(parfile: str | Path) -> pd.DataFrame:
    """Load TOAs/residuals/errs/freqs from libstempo."""
    parfile = Path(parfile)
    if not parfile.exists():
        raise FileNotFoundError(str(parfile))

    all_tim = str(parfile).replace(".par", "_all.tim")
    if not Path(all_tim).exists():
        raise FileNotFoundError(all_tim)

    psr = lt.tempopulsar(parfile=str(parfile), timfile=str(all_tim))

    mjd = np.asarray(psr.toas(), dtype="float64")
    resid = np.asarray(psr.residuals(), dtype="float64")
    sigma = np.asarray(psr.toaerrs(), dtype="float64")
    freq = np.asarray(psr.freqs, dtype="float64")

    out = {
        "mjd": mjd,
        "resid": resid,
        "sigma": sigma,
        "freq": freq,
        "day": np.floor(mjd).astype(int),
    }

    # Optional BAT (depends on build)
    if hasattr(psr, "bat"):
        try:
            out["bat_mjd"] = np.asarray(psr.bat(), dtype="float64")
        except Exception:
            pass

    df = pd.DataFrame(out).sort_values("mjd").reset_index(drop=True)
    return df
